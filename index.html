<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>無事故日数カウンター</title>
    <style>
        :root { --safety-green: #008542; --safety-yellow: #ffed00; }
        body { font-family: sans-serif; background-color: #f0f2f5; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; text-align: center; }
        .card { width: 95%; max-width: 600px; background: white; border: 12px solid var(--safety-green); border-radius: 4px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative; }
        .main { padding: 60px 20px; }
        .days { font-size: 9rem; font-weight: 900; color: var(--safety-green); line-height: 1; margin: 10px 0; font-family: 'Arial Black', sans-serif; }
        .footer { background-color: #f8f9fa; padding: 20px; border-top: 1px solid #ddd; font-size: 1.2rem; }
        .admin-btn { position: absolute; bottom: 0; right: 0; width: 60px; height: 60px; background: transparent; border: none; cursor: pointer; opacity: 0.1; }
    </style>
</head>
<body>
<div class="card">
    <div class="main">
        <div style="font-weight:bold; font-size:1.5rem; color:#555; margin-bottom:10px;">継続無事故日数</div>
        <div class="days"><span id="days-val">--</span><small style="font-size:2rem;">日</small></div>
        <div id="start-date" style="color: #999; margin-top: 15px; font-size: 1rem;">記録開始日: 読み込み中...</div>
    </div>
    <div class="footer">過去の最長記録: <span id="longest-val">--</span> 日</div>
    <button class="admin-btn" onclick="adminReset()"></button>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzzp3IVXjFm1XaZY3Hgl_eQxFnqvZrz7mMdarwi7_vaVML4-qTuMKDqXnZNAii8rDmP/exec";
    const PWD = "5080";

    async function loadData() {
        try {
            const res = await fetch(GAS_URL);
            const data = await res.json();
            
            // 日付を「yyyy/mm/dd」形式から正しく解析
            const parts = data.startDate.split('/');
            const startDate = new Date(parts[0], parts[1] - 1, parts[2]);
            startDate.setHours(0, 0, 0, 0);

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // 経過日数の計算
            const diff = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
            
            document.getElementById('days-val').innerText = diff;
            document.getElementById('longest-val').innerText = data.longestRecord;
            document.getElementById('start-date').innerText = "記録開始日: " + data.startDate;

            // 最長記録の自動更新
            if (diff > data.longestRecord) {
                await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: "updateLongest", value: diff, password: PWD })
                });
                document.getElementById('longest-val').innerText = diff;
            }
        } catch (e) {
            document.getElementById('start-date').innerText = "データ読み込みエラー";
        }
    }

    async function adminReset() {
        const input = prompt("管理者パスワードを入力してください：");
        if (input === PWD) {
            if (confirm("事故リセットを実行します。よろしいですか？")) {
                await fetch(GAS_URL, {
                    method: "POST",
                    mode: "no-cors", // CORSエラー回避
                    body: JSON.stringify({ action: "reset", password: PWD })
                });
                // 書き換え反映まで少し待ってリロード
                setTimeout(() => { location.reload(); }, 500);
            }
        } else if (input !== null) {
            alert("パスワードが違います。");
        }
    }

    loadData();
</script>
</body>
</html>
